[package]
name = "streamweave"
version = "0.1.0"
edition = "2024"
authors = ["Tom Wieland <tom.wieland@gmail.com>"]  # Add your info
description = "Composable, async, stream-first computation in pure Rust"
license = "CC-BY-SA-4.0"
repository = "https://github.com/Industrial/streamweave"  # Add your repo
homepage = "https://github.com/Industrial/streamweave"  # Add homepage
documentation = "https://docs.rs/streamweave"  # Add docs
keywords = ["stream", "async", "pipeline", "data-processing", "rust"]
categories = ["asynchronous", "data-structures", "web-programming::http-server"]
readme = "README.md"

[features]
default = ["native"]

# Native platform features (full functionality)
native = [
    "tokio/full",
    "tokio-stream/io-util",
    "dep:async-compression",
    "dep:hyper-tungstenite",
    "dep:hyper-util",
    "dep:jsonschema",
    "dep:tokio-tungstenite",
    "dep:tokio-util",
    "dep:tracing-subscriber",
    "file-formats",
    "random",
]

# WebAssembly platform features (browser/Node.js compatible)
# Note: Random number generation requires browser crypto API
# UUID and random features are disabled for WASM due to getrandom limitations
wasm = [
    "tokio/sync",
    "tokio/macros",
    "tokio/rt",
    "tokio/time",
]

# Minimal WASM feature for smallest bundle size
# Includes core stream processing with minimal tokio features
wasm-minimal = [
    "tokio/sync",
    "tokio/rt",
    "tokio/time",
    "tokio/macros",
]

# Optional file format support (native only due to file I/O)
file-formats = [
    "dep:arrow",
    "dep:parquet",
    "dep:csv",
    "dep:rmp-serde",
]

# Random number generation support
random = [
    "dep:rand",
    "dep:uuid",
]

# Compression support (native only)
compression = ["dep:async-compression"]

# Kafka integration (native only)
kafka = ["dep:rdkafka"]

# Redis Streams integration (native only)
redis-streams = ["dep:redis"]

# Database integration (native only)
database = ["dep:sqlx"]

[dependencies]
# Async runtime and utilities - base features for both native and WASM
tokio = { version = "1.0", default-features = false }
futures = "0.3"
async-trait = "0.1"

# Compression (native only)
async-compression = { version = "0.4", features = ["tokio", "gzip", "deflate"], optional = true }

# Serialization (always available)
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"

# File format dependencies (native only - requires file I/O)
csv = { version = "1.3", optional = true }
rmp-serde = { version = "1.3", optional = true }
arrow = { version = "54", default-features = false, features = ["ipc"], optional = true }
parquet = { version = "54", default-features = false, features = ["arrow", "snap", "lz4", "zstd"], optional = true }

# JSON Schema validation (optional - not WASM-compatible due to getrandom dependency)
jsonschema = { version = "0.17", optional = true }

# Time handling (works in WASM)
chrono = { version = "0.4", features = ["serde"] }

# Random number generation (optional - required for random producers and UUID message IDs)
rand = { version = "0.8", optional = true }

# UUID generation (optional - required for UUID-based message IDs)
uuid = { version = "1.0", features = ["v4", "serde"], optional = true }

# Pin utilities (works in WASM)
pin-project = "1.0"

# Stream utilities (works in WASM)
async-stream = "0.3.3"

# WebSocket and HTTP (native only)
hyper-tungstenite = { version = "0.13", optional = true }
hyper-util = { version = "0.1", features = ["full"], optional = true }
tokio-tungstenite = { version = "0.21", optional = true }

# Kafka integration (native only - requires librdkafka)
# Note: Requires cmake, pkg-config, openssl, zlib, and zstd to build
# These are provided by devenv.nix when using devenv.sh
# To use SSL, the system must have OpenSSL available (provided by devenv)
rdkafka = { version = "0.36", optional = true, features = ["cmake-build"] }

# Redis Streams integration (native only - requires Redis)
redis = { version = "0.26", optional = true, features = ["tokio-comp", "streams", "connection-manager"] }

# Database integration (native only - requires PostgreSQL/MySQL)
# sqlx with runtime mode for dynamic queries and connection pooling
sqlx = { version = "0.8", optional = true, default-features = false, features = [
  "runtime-tokio-native-tls",
  "postgres",
  "mysql",
  "chrono",
  "uuid",
] }

# Utilities (mostly WASM-compatible)
jsonwebtoken = "9.2"
mime = "0.3"
num-traits = "0.2.19"
regex = "1.10"
serde_urlencoded = "0.7"
sha2 = "0.10"
thiserror = "1.0.57"
tokio-stream = { version = "0.1", default-features = false }
tracing = "0.1.40"
tracing-subscriber = { version = "0.3.20", optional = true }
base64 = "0.22.1"
tokio-util = { version = "0.7.14", optional = true }

[[example]]
name = "01_basic_pipeline"
path = "examples/01_basic_pipeline/main.rs"

[[example]]
name = "02_advanced_pipeline"
path = "examples/02_advanced_pipeline/main.rs"

[dev-dependencies]
proptest = "1.4"
tempfile = "3.10.0"

# Release profile optimizations
[profile.release]
lto = true
codegen-units = 1
panic = "abort"
strip = true

# WASM-optimized release profile
[profile.wasm-release]
inherits = "release"
opt-level = "z"  # Optimize for size
lto = true
codegen-units = 1
panic = "abort"
strip = true