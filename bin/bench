#!/usr/bin/env bash
set -euo pipefail
exec > >(tee log/bench.log) 2>&1 

echo "> bench"

# Check if benches directory exists
if [ ! -d "benches" ]; then
    echo "> bench > no benches directory found"
    echo "> bench > done"
    exit 0
fi

echo "> bench > building benchmarks"
cargo build --release --benches || {
    echo "> bench > warning: failed to build benchmarks (may not exist)"
    exit 0
}

# Get list of available benchmarks
# cargo bench --list outputs benchmark names, try to extract them
BENCHES=$(cargo bench --list 2>/dev/null | grep -E "^[a-z_]+:" | cut -d: -f1 | sort -u || true)

if [ -z "$BENCHES" ]; then
    echo "> bench > no benchmarks found"
    echo "> bench > done"
    exit 0
fi

# Run each available benchmark
for bench in $BENCHES; do
    echo "> bench > running $bench"
    cargo bench --bench "$bench" || {
        echo "> bench > warning: failed to run $bench"
    }
done

echo "> bench > done"
