#!/usr/bin/env bash
# Publish packages in dependency order

set -euo pipefail
exec > >(tee log/publish.log) 2>&1 

echo "> publish"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

cd "$PROJECT_DIR"

# Calculate publish order based on dependencies
echo "> publish > Calculating publish order..."
ORDER=$(scripts/publish-order.sh)

if [ -z "$ORDER" ]; then
    echo "âŒ Error: Could not determine publish order"
    exit 1
fi

echo "> publish > Publishing packages in dependency order:"
for pkg in $ORDER; do
    echo "  - streamweave-$pkg"
done

# Ask for confirmation
read -p "ğŸ¤” Ready to publish all packages? (y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "âŒ Publish cancelled."
    exit 1
fi

# Publish each package
for pkg in $ORDER; do
    echo ""
    echo "ğŸ“¦ Publishing streamweave-$pkg..."
    cargo publish -p "streamweave-$pkg"
    sleep 5  # Rate limiting
done

echo ""
echo "âœ… All packages published successfully!"
