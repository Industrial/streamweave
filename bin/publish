#!/usr/bin/env bash
# Publish packages in dependency order

set -euo pipefail
exec > >(tee log/publish.log) 2>&1 

echo "> publish"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

cd "$PROJECT_DIR"

# Calculate publish order based on dependencies
echo "> publish > Calculating publish order..."
# Get all package directories and convert to package name format
ORDER=$(find packages -name Cargo.toml -type f | while read -r toml; do
    dir=$(dirname "$toml")
    rel_path=${dir#packages/}
    
    # Convert path to package name format
    # streamweave -> streamweave
    # producers/kafka -> producer-kafka
    if [[ "$rel_path" == *"/"* ]]; then
        # Has subdirectory (producers/kafka)
        category=$(echo "$rel_path" | cut -d'/' -f1)
        name=$(echo "$rel_path" | cut -d'/' -f2)
        echo "${category}-${name}"
    else
        # Top-level package (streamweave, pipeline, etc.)
        echo "$rel_path"
    fi
done | sort)

if [ -z "$ORDER" ]; then
    echo "âŒ Error: Could not determine publish order"
    exit 1
fi

echo "> publish > Publishing packages in dependency order:"
for pkg in $ORDER; do
    if [[ "$pkg" == "streamweave" ]]; then
        echo "  - $pkg"
    else
        echo "  - streamweave-$pkg"
    fi
done

# Ask for confirmation
read -p "ğŸ¤” Ready to publish all packages? (y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "âŒ Publish cancelled."
    exit 1
fi

# Publish each package
for pkg in $ORDER; do
    echo ""
    if [[ "$pkg" == "streamweave" ]]; then
        echo "ğŸ“¦ Publishing $pkg..."
        cargo publish -p "$pkg"
    else
        echo "ğŸ“¦ Publishing streamweave-$pkg..."
        cargo publish -p "streamweave-$pkg"
    fi
    sleep 5  # Rate limiting
done

echo ""
echo "âœ… All packages published successfully!"
