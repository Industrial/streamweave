name: ğŸš€ Release & Publish

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'      # v1.2.3
      - 'v[0-9]+.[0-9]+.[0-9]+-*'    # v1.2.3-beta.1

# Only one release at a time
concurrency:
  group: release
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # =============================================================================
  # VALIDATE
  # =============================================================================
  validate:
    name: ğŸ” Validate Release
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/v}"
          echo "version=$TAG" >> $GITHUB_OUTPUT
          
          # Check if this is a prerelease (contains hyphen like -beta, -rc, -alpha)
          if [[ "$TAG" == *"-"* ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ Prerelease version: $TAG"
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ Release version: $TAG"
          fi

      - name: Verify version matches Cargo.toml
        run: |
          CARGO_VERSION=$(grep '^version = ' Cargo.toml | head -1 | cut -d '"' -f 2)
          TAG_VERSION="${{ steps.version.outputs.version }}"
          
          echo "ğŸ“‹ Tag version: $TAG_VERSION"
          echo "ğŸ“‹ Cargo.toml version: $CARGO_VERSION"
          
          if [[ "$CARGO_VERSION" != "$TAG_VERSION" ]]; then
            echo "âŒ Version mismatch!"
            echo "   Tag: v$TAG_VERSION"
            echo "   Cargo.toml: $CARGO_VERSION"
            echo ""
            echo "Please update Cargo.toml version to match the tag."
            exit 1
          fi
          
          echo "âœ… Versions match!"

  # =============================================================================
  # BUILD & TEST
  # =============================================================================
  build:
    name: ğŸ”¨ Build & Test
    runs-on: ubuntu-latest
    needs: validate
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Setup Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: devenv
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: Install devenv
        run: nix profile install github:cachix/devenv --accept-flake-config

      - name: Lint & Format Check
        run: |
          devenv shell -- bash -c "
            echo 'ğŸ” Running lint checks...'
            bin/check
            bin/lint
          "

      - name: Run Tests
        run: |
          devenv shell -- bash -c "
            echo 'ğŸ§ª Running tests...'
            bin/test
          "

      - name: Build Release
        run: |
          devenv shell -- bash -c "
            echo 'ğŸ“¦ Building release...'
            cargo build --release --all-features
          "

      - name: Verify Package
        run: |
          devenv shell -- bash -c "
            echo 'ğŸ” Verifying package...'
            cargo publish --dry-run
          "

  # =============================================================================
  # PUBLISH TO CRATES.IO
  # =============================================================================
  publish:
    name: ğŸ“¤ Publish to crates.io
    runs-on: ubuntu-latest
    needs: [validate, build]
    permissions:
      contents: read
    environment:
      name: crates-io
      url: https://crates.io/crates/streamweave
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Setup Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: devenv
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: Install devenv
        run: nix profile install github:cachix/devenv --accept-flake-config

      - name: Publish to crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          devenv shell -- bash -c "
            echo 'ğŸš€ Publishing v${{ needs.validate.outputs.version }} to crates.io...'
            cargo publish
            echo 'âœ… Published successfully!'
          "

  # =============================================================================
  # CREATE GITHUB RELEASE
  # =============================================================================
  release:
    name: ğŸ‰ Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate, publish]
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          # Get the previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          echo "## What's Changed" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          
          if [[ -n "$PREV_TAG" ]]; then
            echo "Changes since $PREV_TAG:" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            git log --pretty=format:"* %s (%h)" $PREV_TAG..HEAD >> CHANGELOG.md
          else
            echo "Initial release! ğŸ‰" >> CHANGELOG.md
          fi
          
          echo "" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "---" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "ğŸ“¦ **Install from crates.io:**" >> CHANGELOG.md
          echo '```toml' >> CHANGELOG.md
          echo '[dependencies]' >> CHANGELOG.md
          echo 'streamweave = "${{ needs.validate.outputs.version }}"' >> CHANGELOG.md
          echo '```' >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "ğŸ“š **Documentation:** [docs.rs/streamweave](https://docs.rs/streamweave)" >> CHANGELOG.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: v${{ needs.validate.outputs.version }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: ${{ needs.validate.outputs.is_prerelease == 'true' }}
          generate_release_notes: true
          make_latest: ${{ needs.validate.outputs.is_prerelease != 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # =============================================================================
  # PUBLISH DOCUMENTATION
  # =============================================================================
  docs:
    name: ğŸ“š Publish Documentation
    runs-on: ubuntu-latest
    needs: [validate, publish]
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Setup Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@v8

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: devenv
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: Install devenv
        run: nix profile install github:cachix/devenv --accept-flake-config

      - name: Generate documentation
        run: |
          devenv shell -- bash -c "
            echo 'ğŸ“š Generating documentation...'
            cargo doc --all-features --no-deps
            
            # Create redirect index.html
            echo '<meta http-equiv=\"refresh\" content=\"0; url=streamweave/index.html\">' > target/doc/index.html
          "

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: 'target/doc'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # =============================================================================
  # RELEASE SUCCESS NOTIFICATION
  # =============================================================================
  notify:
    name: ğŸ“¢ Release Complete
    runs-on: ubuntu-latest
    needs: [validate, publish, release, docs]
    if: always()
    steps:
      - name: Check release status
        run: |
          if [[ "${{ needs.publish.result }}" != "success" ]]; then
            echo "âŒ Release failed at publish step"
            exit 1
          fi
          
          echo "ğŸ‰ StreamWeave v${{ needs.validate.outputs.version }} released successfully!"
          echo ""
          echo "ğŸ“¦ crates.io: https://crates.io/crates/streamweave/${{ needs.validate.outputs.version }}"
          echo "ğŸ“š docs.rs: https://docs.rs/streamweave/${{ needs.validate.outputs.version }}"
          echo "ğŸ·ï¸ GitHub: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.validate.outputs.version }}"
