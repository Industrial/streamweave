name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # =============================================================================
  # LINT & FORMAT
  # =============================================================================
  lint:
    name: üîç Lint & Format
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Setup Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@v13

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: devenv
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: Install devenv
        run: nix profile install github:cachix/devenv --accept-flake-config

      - name: Check & Lint
        run: |
          devenv shell -- bash -c "
            echo 'üîç Running cargo check + clippy...'
            bin/check
            
            echo '‚ú® Running rustfmt...'
            bin/lint
          "

  # =============================================================================
  # TEST MATRIX
  # =============================================================================
  test:
    name: üß™ Test (${{ matrix.rust }})
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        rust: [stable, beta, nightly]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Setup Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@v13

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: devenv
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: Install devenv
        run: nix profile install github:cachix/devenv --accept-flake-config

      - name: Run tests
        run: |
          devenv shell -- bash -c "
            echo 'üß™ Running tests with Rust ${{ matrix.rust }}...'
            bin/test
          "

  # =============================================================================
  # EXAMPLES
  # =============================================================================
  examples:
    name: üì¶ Build Examples
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Setup Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@v13

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: devenv
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: Install devenv
        run: nix profile install github:cachix/devenv --accept-flake-config

      - name: Build & Test Examples
        run: |
          devenv shell -- bash -c "
            echo 'üì¶ Building examples...'
            cargo build --examples --all-features
            
            echo 'üß™ Testing examples...'
            cargo test --examples --all-features
          "

  # =============================================================================
  # SECURITY AUDIT
  # =============================================================================
  security:
    name: üîí Security Audit
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Setup Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@v13

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: devenv
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: Install devenv
        run: nix profile install github:cachix/devenv --accept-flake-config

      - name: Run cargo-audit
        run: |
          devenv shell -- bash -c "
            cargo install cargo-audit --locked
            echo 'üîí Running security audit...'
            cargo audit
          "

      - name: Run cargo-deny
        run: |
          devenv shell -- bash -c "
            cargo install cargo-deny --locked
            echo 'üìã Checking licenses and dependencies...'
            cargo deny check || echo '‚ö†Ô∏è cargo-deny check completed with warnings'
          "

  # =============================================================================
  # COVERAGE
  # =============================================================================
  coverage:
    name: üìä Coverage
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Setup Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@v13

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: devenv
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: Install devenv
        run: nix profile install github:cachix/devenv --accept-flake-config

      - name: Generate coverage
        run: |
          devenv shell -- bash -c "
            echo 'üìä Generating coverage report...'
            cargo llvm-cov --all-targets --all-features --lcov --output-path lcov.info
          "

      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: lcov.info
          flags: unittests
          name: streamweave-coverage
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

  # =============================================================================
  # DOCUMENTATION
  # =============================================================================
  docs:
    name: üìö Documentation
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Setup Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@v13

      - name: Setup Cachix
        uses: cachix/cachix-action@v15
        with:
          name: devenv
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: Install devenv
        run: nix profile install github:cachix/devenv --accept-flake-config

      - name: Build documentation
        run: |
          devenv shell -- bash -c "
            echo 'üìö Building documentation...'
            RUSTDOCFLAGS='-D warnings' cargo doc --all-features --no-deps
          "

  # =============================================================================
  # CI SUCCESS GATE
  # =============================================================================
  ci-success:
    name: ‚úÖ CI Success
    runs-on: ubuntu-latest
    needs: [lint, test, examples, security, coverage, docs]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.lint.result }}" != "success" ]] || \
             [[ "${{ needs.test.result }}" != "success" ]] || \
             [[ "${{ needs.examples.result }}" != "success" ]] || \
             [[ "${{ needs.security.result }}" != "success" ]] || \
             [[ "${{ needs.coverage.result }}" != "success" ]] || \
             [[ "${{ needs.docs.result }}" != "success" ]]; then
            echo "‚ùå One or more jobs failed"
            exit 1
          fi
          echo "‚úÖ All CI jobs passed!"
